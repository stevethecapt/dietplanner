<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diet Planning System</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div class="flash-messages container">
      {% for category, msg in messages %}
      <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <header>
      <!-- <li>
        <a
          href="/error-demo"
          class="btn-secondary small"
          style="margin-left: 8px"
          >Error Demo</a
        >
      </li> -->
      <nav>
        <div class="logo">DietPlanner</div>
        <ul>
          <li><a href="#home">Home</a></li>
          <li><a href="#features">Features</a></li>
          <li><a href="#about">About</a></li>
          <li><a href="#contact">Contact</a></li>
          {% if session.get('username') %}
          <li><a href="#" id="userBtn">{{ session['username'] }}</a></li>
          <li>
            <a
              href="{{ url_for('food_log') }}"
              class="btn-secondary small"
              style="margin-left: 8px"
              >Food Log</a
            >
          </li>
          <li>
            <a
              href="{{ url_for('history') }}"
              class="btn-secondary small"
              style="margin-left: 8px"
              >Riwayat</a
            >
          </li>
          {% else %}
          <li><a href="{{ url_for('login') }}">Login</a></li>
          <li><a href="{{ url_for('signup') }}">SignUp</a></li>
          {% endif %}
        </ul>
      </nav>
    </header>
    <div id="userPopup" class="user-popup hidden" aria-hidden="true">
      <div class="popup-header">
        <div class="popup-avatar" id="popupAvatar">
          {{ session.get('username')[0]|upper if session.get('username') else ''
          }}
        </div>
        <div class="popup-meta">
          <div class="popup-name" id="popupFullname">&nbsp;</div>
          <div class="popup-email" id="popupEmail">&nbsp;</div>
        </div>
      </div>

      <div class="popup-stats">
        <div class="stat-row">
          <span class="stat-label">BMI terakhir</span
          ><span class="stat-value" id="popupBMI">-</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Target kalori</span
          ><span class="stat-value" id="popupCalories">-</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Target</span
          ><span class="stat-value" id="popupGoal">-</span>
        </div>
        <div class="progress-wrap">
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="popupProgressFill"
              style="width: 0%"
            ></div>
          </div>
          <div class="progress-text" id="popupProgressText">0%</div>
        </div>
      </div>

      <div class="popup-footer">
        <div class="popup-joined">
          <small>Bergabung: <span id="popupJoined">-</span></small>
        </div>
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
      </div>
    </div>
    <script src="{{ url_for('static', filename='user_popup.js') }}"></script>

    <section id="home" class="hero">
      <div class="hero-content">
        <h1>Plan Your Perfect Diet</h1>
        <p>
          Achieve your health goals with personalized diet plans tailored just
          for you.
        </p>

        {% if session.get('username') %}
        <a href="{{ url_for('dietplanner') }}" class="btn-primary"
          >Get Started</a
        >
        <a
          href="{{ url_for('history') }}"
          class="btn-secondary"
          style="margin-left: 12px"
          >Riwayat Progress</a
        >
        {% else %}
        <!-- Unauthenticated: show modal confirm instead of direct link -->
        <a href="#" id="get-started-btn" class="btn-primary">Get Started</a>
        {% endif %}
      </div>
      <div class="hero-image">
        <img
          src="https://via.placeholder.com/600x400/4CAF50/FFFFFF?text=Healthy+Foods"
          alt="Healthy Foods"
        />
      </div>
    </section>

    <section id="features" class="features">
      <h2>Key Features</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-icon">ðŸ§¾</div>
          <h3>Diet Planner</h3>
          <p>
            Hitung BMI/BMR serta dapatkan rekomendasi kalori, protein, dan
            jadwal olahraga.
          </p>
          <div class="feature-cta">
            <a class="btn-primary small" href="{{ url_for('dietplanner') }}"
              >Buka Planner</a
            >
          </div>
        </div>

        <!-- Removed Progress Tracking & Nutrition Tips cards per request -->

        <div class="feature-card">
          <div class="feature-icon">ðŸ¤–</div>
          <h3>AI Chatbot</h3>
          <p>
            Dapatkan saran personal lewat panel chat AI untuk menu dan latihan.
          </p>
          <div class="feature-cta">
            <button class="btn-primary small" onclick="openChatbot()">
              Buka Chatbot
            </button>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <p>&copy; 2023 DietPlanner. All rights reserved.</p>
    </footer>
    <!-- Floating chat button (Tanya Ainya) placed on right-bottom -->
    <div class="ai-chatbot-container" aria-hidden="false">
      <button
        class="btn-primary"
        title="Tanya Ainya"
        aria-label="Tanya Ainya"
        onclick="openChatbot()"
      >
        <span class="btn-logo">ðŸ¤–</span>
      </button>
    </div>

    <!-- Chatbot Panel -->
    <div
      id="chatbotPanel"
      class="chatbot-panel hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="chatbot-title"
    >
      <div class="chatbot-header">
        <span id="chatbot-title">Ainya - DietPlanner Chatbot</span>
        <button class="close-btn" onclick="closeChatbot()" title="Tutup">
          Ã—
        </button>
      </div>
      <div
        id="chatMessages"
        class="chatbot-messages"
        tabindex="0"
        aria-live="polite"
      ></div>
      <div class="chatbot-input-row">
        <input
          id="chatInput"
          type="text"
          placeholder="Tulis pertanyaan seputar diet..."
          autocomplete="off"
        />
        <button class="send-btn" onclick="sendMessage()">Kirim</button>
      </div>
    </div>

    <!-- Auth modal (hidden by default). login URL stored in data-login-url -->
    <div
      id="auth-modal"
      class="modal hidden"
      data-login-url="{{ url_for('login') }}"
      aria-hidden="true"
    >
      <div class="modal-backdrop"></div>
      <div
        class="modal-panel"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
      >
        <h3 id="modal-title">Perlu Login</h3>
        <p>
          Anda harus login untuk melanjutkan ke fitur Diet Planner. Ingin login
          sekarang?
        </p>
        <div class="modal-actions">
          <button id="modal-cancel" class="btn-secondary">Batal</button>
          <button id="modal-ok" class="btn-primary">OK</button>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='chatbot.js') }}"></script>
    <script>
      (function () {
        var btn = document.getElementById("get-started-btn");
        var modal = document.getElementById("auth-modal");
        if (!btn || !modal) return;
        var ok = document.getElementById("modal-ok");
        var cancel = document.getElementById("modal-cancel");
        var backdrop = modal.querySelector(".modal-backdrop");
        function show() {
          modal.classList.remove("hidden");
          modal.style.display = "block";
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
        }
        function hide() {
          modal.classList.add("hidden");
          modal.style.display = "none";
          modal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "auto";
        }
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          show();
        });
        cancel.addEventListener("click", function (e) {
          e.preventDefault();
          hide();
        });
        backdrop.addEventListener("click", function () {
          hide();
        });
        ok.addEventListener("click", function () {
          var url = modal.getAttribute("data-login-url") || "/login";
          window.location.href = url;
        });
        // close on Esc
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") hide();
        });
      })();
    </script>
  </body>
</html>
